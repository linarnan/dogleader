<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>DogLeader XLSX Converter</title>
	<style>
		.upload {
			width: 400px;
			height: 300px;
			border: 1px solid #ccc;
		}

	</style>
</head>

<body>
	<div class="upload">
		<input type="file" id="fileUpload" />
	</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.6/xlsx.full.min.js" integrity="sha384-ICFIncc52ImTVuuv9AcDNFlPIYxvixfuWJRC+WupzaCuRX3vtBQ8BSOv6UbuJnmo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"
	integrity="sha256-wCBClaCr6pJ7sGU5kfb3gQMOOcIZNzaWpWcj/lD9Vfk=" crossorigin="anonymous"></script>
<script>const MatchColNames=["訂單編號 (單)","訂單狀態 (單)","收件者姓名 (單)","商品名稱 (品)","商品選項名稱 (品)","數量","寄送方式 (單)","商品選項貨號"],additionalCol=[{i:"I",name:"營業額",f:""},{i:"J",name:"成本",f:""},{i:"K",name:"利潤",f:"I$-J$"},{i:"L",name:"稅",f:"(I$-J$) * 0.05 + I$ * 0.06 * 0.2"},{i:"M",name:"稅後利潤",f:"I$ - J$"},{i:"N",name:"百分比",f:"M$ / I$"}];function debug(){console.log.apply(console,arguments)}function onFileChanged(e){var o=e.target.files[0],t=new FileReader;t.onload=function(e){loadXLSXBuffer(new Uint8Array(e.target.result))},t.readAsArrayBuffer(o)}function loadXLSXBuffer(e){var o=XLSX.read(e,{type:"array"});console.log(o);var t=parseData(o),a=XLSX.utils.book_new(),n=XLSX.utils.aoa_to_sheet(t);debug("newWs: ",n),debug(a);a.SheetNames.push("result"),a.Sheets.result=n,postProcessing(n,t,additionalCol),debug("wb",a),writeXLSX_workbook(a)}function writeXLSX_workbook(e){var o=dateFormat(new Date);XLSX.writeFile(e,o+".xlsx")}function parseData(e){var o=e.Workbook.Sheets[0].name,t=e.Sheets[o],a=e.Sheets[o]["!ref"].match(/[A-Z]{1,2}\d*:([A-Z]{1,2})(\d*)/),n=(e.Strings,a[2]),l=colName2Num(a[1]);console.log("Max colNum",l);for(var r=[],u={},i=1;i<=l;i++){if(t[cellIdx(i,1)])u[t[cellIdx(i,1)].v]=i}console.log("Column Name Map",u);for(i=0;i<MatchColNames.length;i++){var s=u[MatchColNames[i]];s&&r.push(s)}debug(r);var c=[MatchColNames],d=!1;for(i=1;i<=n;i++){let e=[];d=!1;for(var f=0;f<r.length;f++){let o=cellIdx(r[f],i);if(console.log("Get column value: ",o,t[o]),t[o]){if(1===f&&"待出貨"!==t[o].v){d=!0;break}e.push(t[o].v)}else e.push("")}d||c.push(e)}for(f=0;f<additionalCol.length;f++)Array.prototype.push.call(MatchColNames,additionalCol[f].name);var h=c[0].length;for(i=1;i<c.length;i++)if(c[i].length<h)for(var m=h-c[i].length,g=0;g<m;g++)c[i].push("");return debug("result",c),c}function postProcessing(e,o,t){for(var a=1;a<o.length;a++)for(var n=a+1,l=0;l<t.length;l++){var r=t[l].i;e[`${r}${n}`].f=t[l].f.replace(/\$/g,n),e[`${r}${n}`].t="n"}}function dateFormat(e){var o=e||new Date,t=o.getFullYear(),a=o.getMonth()+1,n=o.getDate();return`${t}-${a<10?"0":""}${a}-${n<10?"0":""}${n}`}const ColIdx="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function cellIdx(e,o){return colNum2Name(e)+o}function colName(e){return ColIdx.charAt(colNum-1)}function colName2Num(e){return 2===e.length?26*(ColIdx.indexOf(e[0])+1)+(ColIdx.indexOf(e[1])+1):ColIdx.indexOf(e[0])+1}function colNum2Name(e){return e<=26?ColIdx.charAt(e-1):ColIdx.charAt(Number.parseInt(e/26)-1)+ColIdx.charAt(Number.parseInt(e%26)-1)}function bootstrap(){document.getElementById("fileUpload").addEventListener("change",onFileChanged,!1)}</script>
<script type="module">
	window.addEventListener("DOMContentLoaded", event => {
			bootstrap();
		});
	</script>
</html>